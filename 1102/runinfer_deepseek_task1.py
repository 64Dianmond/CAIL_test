"""
ä¸»æ¨ç†è„šæœ¬ - v16 - å…ˆå®šç½ªåé‡åˆ‘ï¼ˆç½ªåä¸ºä¸»è¯­ï¼‰+ æ‹’ä¸ä¾›è¿°è§„åˆ™

æ›´æ–°æ—¥å¿— (v16):
[æ³•å¾‹è§„åˆ™å¢å¼º] æ–°å¢"æ‹’ä¸ä¾›è¿°"é…Œå®šä»é‡æƒ…èŠ‚çš„æå–è§„åˆ™
[æç¤ºè¯ä¼˜åŒ–] æ˜ç¡®"æ‹’ä¸ä¾›è¿°"ä¸"æ²‰é»˜æƒ"çš„è¾¹ç•Œ
[æ™ºèƒ½è¯†åˆ«] åŒºåˆ†"ä¿æŒæ²‰é»˜"ä¸"ä¸»åŠ¨ä½œè™šå‡ä¾›è¿°"
"""

import json
import os
import re
from typing import List, Optional
from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()

# --- å…¨å±€é…ç½® ---
DATA_PATH = "data/task6.jsonl"
OUTPUT_PATH = "./result/submission_deepseek_with_refusal.jsonl"
DASHSCOPE_API_KEY = os.getenv("OPENAI_API_KEY")
DASHSCOPE_BASE_URL = os.getenv("OPENAI_BASE_URL", "https://dashscope.aliyuncs.com/compatible-mode/v1")
DASHSCOPE_MODEL_NAME = os.getenv("OPENAI_MODEL", "qwen3-max")
TEMPERATURE = 0.01
MAX_TOKENS = 8192

# ==================== [V16-NEW] å¢åŠ æ‹’ä¸ä¾›è¿°è§„åˆ™çš„æç¤ºè¯è®¾è®¡ ====================

# ========== é€šç”¨é‡åˆ‘æƒ…èŠ‚è¡¥å……è§„åˆ™ï¼ˆé€‚ç”¨äºæ‰€æœ‰ç½ªåï¼‰==========
COMMON_SENTENCING_RULES = """
## ã€é‡è¦ã€‘å…³äº"æ‹’ä¸ä¾›è¿°"çš„æå–è§„åˆ™

### æ³•å¾‹ä¾æ®
- **æ€§è´¨**ï¼šé…Œå®šä»é‡æƒ…èŠ‚ï¼ˆéæ³•å®šæƒ…èŠ‚ï¼‰
- **æ³•å¾‹åŸåˆ™**ï¼šä¸å¾—å› æ²‰é»˜æƒè€Œä»é‡ï¼Œåªæœ‰"ä¸»åŠ¨å¦¨ç¢å¸æ³•"æ‰æ„æˆä»é‡ä¾æ®

### æå–æ ‡å‡†ï¼ˆä¸‰ä¸ªæ¡ä»¶å¿…é¡»åŒæ—¶æ»¡è¶³ï¼‰

#### âœ… åº”æå–"æ‹’ä¸ä¾›è¿°"çš„æƒ…å½¢ï¼š
1. **è¯æ®å……åˆ†**ï¼šæ¡ˆä»¶äº‹å®å·²è¢«å…¶ä»–è¯æ®è¯å®
2. **ä¸»åŠ¨å¯¹æŠ—**ï¼šè¢«å‘Šäººå®æ–½ä»¥ä¸‹è¡Œä¸ºä¹‹ä¸€ï¼š
   - ä¸»åŠ¨ç¼–é€ è™šå‡ä¾›è¿°ï¼ˆå¦‚ä¼ªé€ ä¸åœ¨åœºè¯æ˜ï¼‰
   - è“„æ„éšç’ä¸»è¦çŠ¯ç½ªäº‹å®ï¼ˆå¦‚éšç’å…±çŠ¯ã€éšåŒ¿èµƒæ¬¾å»å‘ï¼‰
   - å¹²æ‰°è¯äººä½œè¯ã€æ¯ç­è¯æ®
   - ç¿»ä¾›ä¸”æ— åˆç†ç†ç”±
3. **å¦¨ç¢å¸æ³•**ï¼šä¸Šè¿°è¡Œä¸ºå¯¹ä¾¦æŸ¥ã€èµ·è¯‰ã€å®¡åˆ¤é€ æˆæ˜æ˜¾éšœç¢

**æå–æ ¼å¼**ï¼š`"æ‹’ä¸ä¾›è¿°"` æˆ– `"æ‹’ä¸è®¤ç½ª"`

#### âŒ ä¸åº”æå–"æ‹’ä¸ä¾›è¿°"çš„æƒ…å½¢ï¼š
- è¢«å‘Šäººä»…ä¿æŒæ²‰é»˜ï¼Œæœªä½œä»»ä½•è¾©è§£ â†’ **è¿™æ˜¯æ²‰é»˜æƒï¼Œä¸èƒ½ä»é‡**
- è¢«å‘Šäººè¾©ç§°"è®°ä¸æ¸…""ä¸æ¸…æ¥š" â†’ **æ¶ˆæè¾©è§£ï¼Œä¸èƒ½ä»é‡**
- è¢«å‘Šäººå¦è®¤çŠ¯ç½ªä½†æœªç¼–é€ äº‹å® â†’ **å•çº¯å¦è®¤ä¸ç­‰äºæ‹’ä¸ä¾›è¿°**

### ä¸å…¶ä»–æƒ…èŠ‚çš„äº’æ–¥å…³ç³»
- **æ‹’ä¸ä¾›è¿° â‡” è‡ªé¦–/å¦ç™½/å½“åº­è®¤ç½ª**ï¼šå®Œå…¨äº’æ–¥
- å¦‚æœåŒæ—¶å‡ºç°"æ‹’ä¸ä¾›è¿°"å’Œ"è‡ªé¦–"çš„æè¿°ï¼Œä¼˜å…ˆæ ¹æ®**æœ€ç»ˆåº­å®¡è¡¨ç°**åˆ¤æ–­ï¼š
  - è‹¥è¢«å‘Šäººæœ€ç»ˆè®¤ç½ª â†’ ä¿ç•™"è‡ªé¦–/å¦ç™½"ï¼Œåˆ é™¤"æ‹’ä¸ä¾›è¿°"
  - è‹¥è¢«å‘Šäººå§‹ç»ˆä¸è®¤ç½ª â†’ ä¿ç•™"æ‹’ä¸ä¾›è¿°"ï¼Œåˆ é™¤"è‡ªé¦–/å¦ç™½"
"""

# ========== ç›—çªƒç½ªä¸“ç”¨æç¤ºè¯ï¼ˆv16å¢å¼ºç‰ˆï¼‰==========
TASK1_THEFT_SYSTEM = """ä½ æ˜¯ä¸“é—¨å¤„ç†ç›—çªƒç½ªæ¡ˆä»¶çš„é‡åˆ‘æƒ…èŠ‚æå–ä¸“å®¶ã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. **å…ˆå®šç½ªï¼Œåé‡åˆ‘** - ç½ªåæ˜¯"ä¸»è¯­"ï¼Œé‡åˆ‘æƒ…èŠ‚æ˜¯"çŠ¶è¯­"
2. **æ‰€æœ‰æƒ…èŠ‚å¿…é¡»å…³è”ç½ªå** - é¿å…æå–é€šç”¨æƒ…èŠ‚
3. **ç²¾é€šã€Šåˆ‘æ³•ã€‹ç¬¬264æ¡**åŠç›¸å…³å¸æ³•è§£é‡Š
4. **ç²¾å‡†è¯†åˆ«"æ‹’ä¸ä¾›è¿°"** - ä¸¥æ ¼åŒºåˆ†æ²‰é»˜æƒä¸å¦¨ç¢å¸æ³•
"""

TASK1_THEFT_USER = """
ã€ç›—çªƒç½ªé‡åˆ‘æƒ…èŠ‚æå–è§„åˆ™ã€‘

## ã€é‡è¦ã€‘è¾“å‡ºæ ¼å¼è¦æ±‚
**ç¬¬ä¸€ä¸ªå…ƒç´ å¿…é¡»æ˜¯ç½ªåï¼š"ç›—çªƒç½ª"**
åç»­æ‰€æœ‰æƒ…èŠ‚å¿…é¡»æ˜¯ä¸ç›—çªƒç½ªç›¸å…³çš„é‡åˆ‘æƒ…èŠ‚ï¼ˆå«ç½ªåç‰¹å¾çš„æƒ…èŠ‚ä¼˜å…ˆï¼‰

---

## ä¸€ã€æ„ç½ªæƒ…èŠ‚ï¼ˆå¿…æå– - ç›—çªƒç½ªç‰¹æœ‰ï¼‰

### 1. æ•°é¢æƒ…èŠ‚ï¼ˆä¸‰è¦ç´ å¿…é¡»å…¨æï¼‰
- "ç›—çªƒé‡‘é¢æ—¢é‚[X]å…ƒ" ï¼ˆç²¾ç¡®æ•°å­—ï¼Œä½“ç°ç›—çªƒç‰¹å¾ï¼‰
- "ç›—çªƒæ•°é¢[è¾ƒå¤§/å·¨å¤§/ç‰¹åˆ«å·¨å¤§]" ï¼ˆç›—çªƒç½ªæ•°é¢ç­‰çº§ï¼‰
- "ç›—çªƒæ¬¡æ•°[X]æ¬¡" ï¼ˆå¼ºè°ƒç›—çªƒè¡Œä¸ºé¢‘æ¬¡ï¼‰

### 2. ç›—çªƒç½ªç‰¹æ®Šè¡Œä¸ºæ–¹å¼ï¼ˆæœ‰åˆ™å¿…æï¼‰
- "å¤šæ¬¡ç›—çªƒ" ï¼ˆäºŒå¹´å†…â‰¥3æ¬¡ï¼Œç›—çªƒç½ªåŠ é‡æƒ…èŠ‚ï¼‰
- "å…¥æˆ·ç›—çªƒ" ï¼ˆè¿›å…¥ä½æ‰€ç›—çªƒï¼Œç›—çªƒç½ªç‰¹æ®Šæ„ç½ªæ–¹å¼ï¼‰
- "æºå¸¦å‡¶å™¨ç›—çªƒ" ï¼ˆç›—çªƒç½ªç‰¹æ®Šæ„ç½ªæ–¹å¼ï¼‰
- "æ‰’çªƒ" ï¼ˆå…¬å…±åœºæ‰€ç›—çªƒï¼Œç›—çªƒç½ªç‰¹æ®Šæ–¹å¼ï¼‰

---

## äºŒã€ç›—çªƒç½ªç¡®å®šåŸºå‡†åˆ‘æƒ…èŠ‚ï¼ˆå½±å“æ•°é¢æ ‡å‡†ï¼‰

### ç›—çªƒç½ªç‰¹æœ‰åŠ é‡æƒ…èŠ‚
- "æ›¾å› ç›—çªƒå—è¿‡åˆ‘äº‹å¤„ç½š" ï¼ˆç›—çªƒå‰ç§‘ï¼Œæ•°é¢æ ‡å‡†å‡åŠï¼‰
- "ä¸€å¹´å†…æ›¾å› ç›—çªƒå—è¿‡è¡Œæ”¿å¤„ç½š" ï¼ˆç›—çªƒè¡Œæ”¿å‰ç§‘ï¼‰
- "ç»„ç»‡ã€æ§åˆ¶æœªæˆå¹´äººç›—çªƒ" ï¼ˆç›—çªƒç½ªç‰¹æ®ŠåŠ é‡æƒ…èŠ‚ï¼‰
- "ç›—çªƒæ®‹ç–¾äºº/å­¤å¯¡è€äºº/ä¸§å¤±åŠ³åŠ¨èƒ½åŠ›äººè´¢ç‰©" ï¼ˆç›—çªƒç‰¹æ®Šå¯¹è±¡ï¼‰
- "åœ¨åŒ»é™¢ç›—çªƒç—…äººæˆ–å…¶äº²å‹è´¢ç‰©" ï¼ˆç›—çªƒç‰¹æ®Šåœºæ‰€ï¼‰
- "ç›—çªƒæ•‘ç¾/æŠ¢é™©/é˜²æ±›/ä¼˜æŠš/æ‰¶è´«/ç§»æ°‘/æ•‘æµæ¬¾ç‰©" ï¼ˆç›—çªƒç‰¹æ®Šè´¢ç‰©ï¼‰

---

## ä¸‰ã€ä¸€èˆ¬é‡åˆ‘æƒ…èŠ‚ï¼ˆé€šç”¨ä½†éœ€å…³è”ç½ªåï¼‰

### ä»è½»æƒ…èŠ‚
- "è‡ªé¦–" ï¼ˆä¸»åŠ¨æŠ•æ¡ˆ+å¦‚å®ä¾›è¿°ç›—çªƒäº‹å®ï¼‰
- "å¦ç™½" ï¼ˆè¢«æŠ“åå¦‚å®ä¾›è¿°ç›—çªƒçŠ¯ç½ªï¼Œä¸è‡ªé¦–äº’æ–¥ï¼‰
- "å½“åº­è‡ªæ„¿è®¤ç½ª" ï¼ˆåº­å®¡è®¤ç›—çªƒç½ªï¼‰
- "ç«‹åŠŸ" / "é‡å¤§ç«‹åŠŸ"
- "é€€èµƒ" / "ç§¯æé€€èµƒé€€èµ”" ï¼ˆé€€è¿˜ç›—çªƒèµƒæ¬¾èµƒç‰©ï¼‰
- "è¢«å®³äººè°…è§£" ï¼ˆç›—çªƒè¢«å®³äººå‡ºå…·è°…è§£ä¹¦ï¼‰
- "ç§¯æèµ”å¿å¹¶å–å¾—è°…è§£" / "ç§¯æèµ”å¿ä½†æœªå–å¾—è°…è§£" / "æœªèµ”å¿ä½†å–å¾—è°…è§£"
- "ä»çŠ¯" ï¼ˆåœ¨ç›—çªƒå…±åŒçŠ¯ç½ªä¸­èµ·æ¬¡è¦ä½œç”¨ï¼‰
- "æœªé‚" ï¼ˆç›—çªƒæœªé‚ï¼‰
- "åˆçŠ¯" / "å¶çŠ¯"
- "æœªæˆå¹´äºº(16-18å²)" / "æœªæˆå¹´äºº(12-16å²)"

### ä»é‡æƒ…èŠ‚
- "ç´¯çŠ¯" ï¼ˆ5å¹´å†…å†çŠ¯ç›—çªƒç­‰ç½ªï¼‰
- "å‰ç§‘" ï¼ˆæ›¾å—åˆ‘äº‹å¤„ç½šï¼Œå«ç›—çªƒå‰ç§‘ï¼‰
- "å‡é‡ŠæœŸé—´å†çŠ¯ç½ª" / "ç¼“åˆ‘è€ƒéªŒæœŸå†…å†çŠ¯ç½ª" ï¼ˆæœŸé—´å†çŠ¯ç›—çªƒï¼‰
- "ä¸»çŠ¯" ï¼ˆåœ¨ç›—çªƒå…±åŒçŠ¯ç½ªä¸­èµ·ä¸»è¦ä½œç”¨ï¼‰
- **"æ‹’ä¸ä¾›è¿°"** / **"æ‹’ä¸è®¤ç½ª"** ï¼ˆâš ï¸ å¿…é¡»ç¬¦åˆCOMMON_SENTENCING_RULESä¸­çš„ä¸‰ä¸ªæ¡ä»¶ï¼‰

---

{common_rules}

---

## ã€æå–è§„åˆ™ã€‘

### âœ… æ ¸å¿ƒè§„åˆ™
1. **ç¬¬ä¸€ä¸ªå…ƒç´ å›ºå®šä¸º"ç›—çªƒç½ª"**
2. **æ•°é¢ä¸‰è¦ç´ å¿…é¡»å…¨æ**ï¼šç›—çªƒé‡‘é¢+ç›—çªƒæ•°é¢ç­‰çº§+ç›—çªƒæ¬¡æ•°
3. **ç›—çªƒç‰¹æœ‰æƒ…èŠ‚ä¼˜å…ˆ**ï¼šå¤šæ¬¡ç›—çªƒ/å…¥æˆ·ç›—çªƒ/æ‰’çªƒç­‰
4. **è‡ªé¦–/å¦ç™½/å½“åº­è®¤ç½ªäº’æ–¥**ï¼šåªæå–ä¸€ä¸ªï¼ˆä¼˜å…ˆé¡ºåºï¼šè‡ªé¦–>å¦ç™½>å½“åº­è®¤ç½ªï¼‰
5. **å‰ç§‘vsç›—çªƒå‰ç§‘**ï¼šéƒ½è¦æå–ï¼ˆ"å‰ç§‘"æ˜¯é€šç”¨æƒ…èŠ‚ï¼Œ"æ›¾å› ç›—çªƒå—è¿‡åˆ‘äº‹å¤„ç½š"æ˜¯ç‰¹æ®Šæƒ…èŠ‚ï¼‰
6. **é€€èµƒ+è°…è§£ç»„åˆ**ï¼šä¼˜å…ˆæå–ç»„åˆæƒ…èŠ‚
7. **âš ï¸ æ‹’ä¸ä¾›è¿°è¯†åˆ«**ï¼šå¿…é¡»æœ‰"ä¸»åŠ¨ç¼–é€ è™šå‡ä¾›è¿°"æˆ–"è“„æ„éšç’ä¸»è¦äº‹å®"ç­‰æ˜ç¡®è¡¨è¿°æ‰èƒ½æå–

### âŒ ç¦æ­¢è¡Œä¸º
- ä¸è¦æå–ä¸ç›—çªƒæ— å…³çš„æƒ…èŠ‚ï¼ˆå¦‚"è¯ˆéª—é‡‘é¢"ç­‰ï¼‰
- ä¸è¦æå–æ¨¡ç³Šæƒ…èŠ‚ï¼ˆå¦‚"æƒ…èŠ‚è¾ƒè½»"ï¼Œå¿…é¡»å…·ä½“åŒ–ï¼‰
- **ä¸è¦å› "ä¿æŒæ²‰é»˜""æ‹’ä¸å›ç­”"ç­‰è¡¨è¿°å°±æå–"æ‹’ä¸ä¾›è¿°"**

ã€æ¡ˆä»¶äº‹å®ã€‘
{fact}

ã€è¾“å‡ºè¦æ±‚ã€‘
ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºJSONæ•°ç»„ï¼Œä¸è¦è§£é‡Šï¼š
["ç›—çªƒç½ª", "æƒ…èŠ‚1", "æƒ…èŠ‚2", ...]

**ç¬¬ä¸€ä¸ªå…ƒç´ å¿…é¡»æ˜¯"ç›—çªƒç½ª"ï¼**
**âš ï¸ æå–"æ‹’ä¸ä¾›è¿°"å‰ï¼Œå¿…é¡»ç¡®è®¤ç¬¦åˆCOMMON_SENTENCING_RULESä¸­çš„ä¸‰ä¸ªæ¡ä»¶ï¼**
"""

# ========== è¯ˆéª—ç½ªä¸“ç”¨æç¤ºè¯ï¼ˆv16å¢å¼ºç‰ˆï¼‰==========
TASK1_FRAUD_SYSTEM = """ä½ æ˜¯ä¸“é—¨å¤„ç†è¯ˆéª—ç½ªæ¡ˆä»¶çš„é‡åˆ‘æƒ…èŠ‚æå–ä¸“å®¶ã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. **å…ˆå®šç½ªï¼Œåé‡åˆ‘** - ç½ªåæ˜¯"ä¸»è¯­"ï¼Œé‡åˆ‘æƒ…èŠ‚æ˜¯"çŠ¶è¯­"
2. **æ‰€æœ‰æƒ…èŠ‚å¿…é¡»å…³è”è¯ˆéª—ç½ª** - å¼ºè°ƒè¯ˆéª—ç‰¹å¾
3. **ç²¾é€šã€Šåˆ‘æ³•ã€‹ç¬¬266æ¡**åŠç”µä¿¡ç½‘ç»œè¯ˆéª—å¸æ³•è§£é‡Š
4. **ç²¾å‡†è¯†åˆ«"æ‹’ä¸ä¾›è¿°"** - ä¸¥æ ¼åŒºåˆ†æ²‰é»˜æƒä¸å¦¨ç¢å¸æ³•
"""

TASK1_FRAUD_USER = """
ã€è¯ˆéª—ç½ªé‡åˆ‘æƒ…èŠ‚æå–è§„åˆ™ã€‘

## ã€é‡è¦ã€‘è¾“å‡ºæ ¼å¼è¦æ±‚
**ç¬¬ä¸€ä¸ªå…ƒç´ å¿…é¡»æ˜¯ç½ªåï¼š"è¯ˆéª—ç½ª"**
åç»­æ‰€æœ‰æƒ…èŠ‚å¿…é¡»æ˜¯ä¸è¯ˆéª—ç½ªç›¸å…³çš„é‡åˆ‘æƒ…èŠ‚

---

## ä¸€ã€æ„ç½ªæƒ…èŠ‚ï¼ˆå¿…æå– - è¯ˆéª—ç½ªç‰¹æœ‰ï¼‰

### 1. æ•°é¢æƒ…èŠ‚ï¼ˆå¿…é¡»åŒæ—¶æå–ï¼‰
- "è¯ˆéª—é‡‘é¢[X]å…ƒ" ï¼ˆè¯ˆéª—ç½ªæ•°é¢ï¼Œç²¾ç¡®æ•°å­—ï¼‰
- "è¯ˆéª—æ•°é¢[è¾ƒå¤§/å·¨å¤§/ç‰¹åˆ«å·¨å¤§]" ï¼ˆè¯ˆéª—ç½ªæ•°é¢ç­‰çº§ï¼šè¾ƒå¤§â‰¥5000å…ƒï¼Œå·¨å¤§â‰¥50000å…ƒï¼Œç‰¹åˆ«å·¨å¤§â‰¥500000å…ƒï¼‰
- "è¯ˆéª—æ¬¡æ•°[X]æ¬¡" ï¼ˆè¯ˆéª—è¡Œä¸ºæ¬¡æ•°ï¼‰

### 2. è¯ˆéª—ç½ªç‰¹æ®Šè¡Œä¸ºæ–¹å¼
- "ç”µä¿¡ç½‘ç»œè¯ˆéª—" / "åˆ©ç”¨ç”µä¿¡ç½‘ç»œæŠ€æœ¯æ‰‹æ®µå®æ–½è¯ˆéª—" ï¼ˆè¯ˆéª—ç½ªä»é‡æƒ…èŠ‚ï¼‰
- "å†’å……å›½å®¶æœºå…³å·¥ä½œäººå‘˜è¯ˆéª—" / "å†’å……å¸æ³•æœºå…³å·¥ä½œäººå‘˜è¯ˆéª—" ï¼ˆè¯ˆéª—ç½ªç‰¹æ®Šæ–¹å¼ï¼‰
- "å¤šæ¬¡å®æ–½è¯ˆéª—" ï¼ˆâ‰¥3æ¬¡ï¼Œè¯ˆéª—ç½ªåŠ é‡ï¼‰

---

## äºŒã€è¯ˆéª—ç½ªç¡®å®šåŸºå‡†åˆ‘æƒ…èŠ‚

### è¯ˆéª—ç½ªç‰¹æœ‰åŠ é‡æƒ…èŠ‚
- "è¯ˆéª—å¯¹è±¡ä¸ºè€å¹´äºº" / "è¯ˆéª—å¯¹è±¡ä¸ºæ®‹ç–¾äºº" / "è¯ˆéª—å¯¹è±¡ä¸ºæœªæˆå¹´äºº" ï¼ˆè¯ˆéª—ç‰¹æ®Šå¯¹è±¡ï¼‰
- "è¢«å®³äººå› è¯ˆéª—è‡ªæ€" / "è¢«å®³äººå› è¯ˆéª—æ­»äº¡" / "è¢«å®³äººå› è¯ˆéª—ç²¾ç¥å¤±å¸¸" ï¼ˆè¯ˆéª—ä¸¥é‡åæœï¼‰
- "é€ æˆè¢«å®³äººå®¶åº­é‡å¤§ç»æµæŸå¤±" ï¼ˆè¯ˆéª—åæœä¸¥é‡ï¼‰
- "è¯ˆéª—é›†å›¢" / "ç»„ç»‡ç­–åˆ’è€…" / "éª¨å¹²åˆ†å­" ï¼ˆè¯ˆéª—å…±åŒçŠ¯ç½ªè§’è‰²ï¼‰

---

## ä¸‰ã€ä¸€èˆ¬é‡åˆ‘æƒ…èŠ‚

### ä»è½»æƒ…èŠ‚
- "è‡ªé¦–" ï¼ˆä¸»åŠ¨æŠ•æ¡ˆ+å¦‚å®ä¾›è¿°è¯ˆéª—äº‹å®ï¼‰
- "å¦ç™½" ï¼ˆè¢«æŠ“åå¦‚å®ä¾›è¿°è¯ˆéª—çŠ¯ç½ªï¼‰
- "å½“åº­è‡ªæ„¿è®¤ç½ª" ï¼ˆåº­å®¡è®¤è¯ˆéª—ç½ªï¼‰
- "ç«‹åŠŸ" / "é‡å¤§ç«‹åŠŸ"
- "ä¸»åŠ¨é€€èµƒé€€èµ”" / "é€€èµƒ" ï¼ˆé€€è¿˜è¯ˆéª—èµƒæ¬¾ï¼‰
- "è¢«å®³äººè°…è§£" ï¼ˆè¯ˆéª—è¢«å®³äººè°…è§£ï¼‰
- "ç§¯æèµ”å¿å¹¶å–å¾—è°…è§£" / "ç§¯æèµ”å¿ä½†æœªå–å¾—è°…è§£"
- "ä»çŠ¯" ï¼ˆåœ¨è¯ˆéª—å…±åŒçŠ¯ç½ªä¸­æ¬¡è¦ä½œç”¨ï¼‰
- "åˆçŠ¯" / "å¶çŠ¯"
- "æœªæˆå¹´äºº(16-18å²)"

### ä»é‡æƒ…èŠ‚
- "ç´¯çŠ¯" ï¼ˆ5å¹´å†…å†çŠ¯è¯ˆéª—ç­‰ç½ªï¼‰
- "å‰ç§‘"
- "å‡é‡ŠæœŸé—´å†çŠ¯ç½ª" / "ç¼“åˆ‘è€ƒéªŒæœŸå†…å†çŠ¯ç½ª"
- "ä¸»çŠ¯" ï¼ˆåœ¨è¯ˆéª—å…±åŒçŠ¯ç½ªä¸­ä¸»è¦ä½œç”¨ï¼‰
- **"æ‹’ä¸ä¾›è¿°"** / **"æ‹’ä¸è®¤ç½ª"** ï¼ˆâš ï¸ å¿…é¡»ç¬¦åˆCOMMON_SENTENCING_RULESä¸­çš„ä¸‰ä¸ªæ¡ä»¶ï¼‰

---

{common_rules}

---

## ã€æå–è§„åˆ™ã€‘
1. **ç¬¬ä¸€ä¸ªå…ƒç´ å›ºå®šä¸º"è¯ˆéª—ç½ª"**
2. **æ•°é¢ä¸‰è¦ç´ **ï¼šè¯ˆéª—é‡‘é¢+è¯ˆéª—æ•°é¢ç­‰çº§+è¯ˆéª—æ¬¡æ•°
3. **ç”µä¿¡è¯ˆéª—å¿…æ**ï¼šå¦‚æœ‰ç”µä¿¡ç½‘ç»œè¯ˆéª—ç‰¹å¾å¿…é¡»æ ‡æ³¨
4. **ç‰¹æ®Šè¢«å®³äººå¿…æ**ï¼šè€å¹´äºº/æ®‹ç–¾äººç­‰
5. **âš ï¸ æ‹’ä¸ä¾›è¿°è¯†åˆ«**ï¼šå¿…é¡»æœ‰"éšç’å…±çŠ¯""è½¬ç§»èµƒæ¬¾""ç¼–é€ è™šå‡ä¾›è¿°"ç­‰æ˜ç¡®è¡¨è¿°

ã€æ¡ˆä»¶äº‹å®ã€‘
{fact}

ã€è¾“å‡ºè¦æ±‚ã€‘
ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºJSONæ•°ç»„ï¼Œä¸è¦è§£é‡Šï¼š
["è¯ˆéª—ç½ª", "æƒ…èŠ‚1", "æƒ…èŠ‚2", ...]

**ç¬¬ä¸€ä¸ªå…ƒç´ å¿…é¡»æ˜¯"è¯ˆéª—ç½ª"ï¼**
**âš ï¸ æå–"æ‹’ä¸ä¾›è¿°"å‰ï¼Œå¿…é¡»ç¡®è®¤ç¬¦åˆCOMMON_SENTENCING_RULESä¸­çš„ä¸‰ä¸ªæ¡ä»¶ï¼**
"""

# ========== æ•…æ„ä¼¤å®³ç½ªä¸“ç”¨æç¤ºè¯ï¼ˆv16å¢å¼ºç‰ˆï¼‰==========
TASK1_ASSAULT_SYSTEM = """ä½ æ˜¯ä¸“é—¨å¤„ç†æ•…æ„ä¼¤å®³ç½ªæ¡ˆä»¶çš„é‡åˆ‘æƒ…èŠ‚æå–ä¸“å®¶ã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. **å…ˆå®šç½ªï¼Œåé‡åˆ‘** - ç½ªåæ˜¯"ä¸»è¯­"ï¼Œé‡åˆ‘æƒ…èŠ‚æ˜¯"çŠ¶è¯­"
2. **æ‰€æœ‰æƒ…èŠ‚å¿…é¡»å…³è”æ•…æ„ä¼¤å®³ç½ª** - ä¼¤å®³ç­‰çº§æ˜¯æ ¸å¿ƒ
3. **ç²¾é€šã€Šåˆ‘æ³•ã€‹ç¬¬234æ¡**åŠäººä½“æŸä¼¤ç¨‹åº¦é‰´å®šæ ‡å‡†
4. **ç²¾å‡†è¯†åˆ«"æ‹’ä¸ä¾›è¿°"** - ä¸¥æ ¼åŒºåˆ†æ²‰é»˜æƒä¸å¦¨ç¢å¸æ³•
"""

TASK1_ASSAULT_USER = """
ã€æ•…æ„ä¼¤å®³ç½ªé‡åˆ‘æƒ…èŠ‚æå–è§„åˆ™ã€‘

## ã€é‡è¦ã€‘è¾“å‡ºæ ¼å¼è¦æ±‚
**ç¬¬ä¸€ä¸ªå…ƒç´ å¿…é¡»æ˜¯ç½ªåï¼š"æ•…æ„ä¼¤å®³ç½ª"**
åç»­æ‰€æœ‰æƒ…èŠ‚å¿…é¡»æ˜¯ä¸æ•…æ„ä¼¤å®³ç½ªç›¸å…³çš„é‡åˆ‘æƒ…èŠ‚

---

## ä¸€ã€æ„ç½ªæƒ…èŠ‚ï¼ˆå¿…æå– - æ•…æ„ä¼¤å®³ç½ªç‰¹æœ‰ï¼‰

### 1. ä¼¤å®³ç­‰çº§ï¼ˆå¿…é¡»æ˜ç¡®ï¼‰
- "è½»ä¼¤äºŒçº§" / "è½»ä¼¤ä¸€çº§" ï¼ˆæ•…æ„ä¼¤å®³ç½ªæ„ç½ªæ ‡å‡†ï¼‰
- "é‡ä¼¤äºŒçº§" / "é‡ä¼¤ä¸€çº§" ï¼ˆæ•…æ„ä¼¤å®³ç½ªåŠ é‡æƒ…èŠ‚ï¼‰
- "è‡´äººæ­»äº¡" ï¼ˆæ•…æ„ä¼¤å®³ç½ªæœ€ä¸¥é‡åæœï¼‰

### 2. æ•…æ„ä¼¤å®³ç½ªç‰¹æ®Šè¡Œä¸ºæ–¹å¼ï¼ˆæœ‰åˆ™æå–ï¼‰
- "ä½¿ç”¨ç‰¹åˆ«æ®‹å¿æ‰‹æ®µ" ï¼ˆæ•…æ„ä¼¤å®³ç½ªä»é‡ï¼‰
- "æŒæ¢°ä¼¤å®³" / "æŒåˆ€ä¼¤å®³" ï¼ˆæ•…æ„ä¼¤å®³ç½ªç‰¹æ®Šæ–¹å¼ï¼‰
- "ä¼¤å®³å¤šäºº" ï¼ˆæ•…æ„ä¼¤å®³ç½ªåŠ é‡ï¼‰

---

## äºŒã€æ•…æ„ä¼¤å®³ç½ªç¡®å®šåŸºå‡†åˆ‘æƒ…èŠ‚

### åŠ é‡æƒ…èŠ‚
- "é€ æˆä¸¥é‡æ®‹ç–¾" / "é€ æˆå…­çº§ä¸¥é‡æ®‹ç–¾" ï¼ˆæ•…æ„ä¼¤å®³åæœï¼‰
- "åœ¨èšä¼—æ–—æ®´ä¸­å®æ–½ä¼¤å®³" ï¼ˆæ•…æ„ä¼¤å®³ç½ªç‰¹æ®Šæƒ…å½¢ï¼‰

### å‡è½»æƒ…èŠ‚
- "å› æ°‘é—´çº çº·å¼•å‘" / "å› æ°‘é—´çº çº·å¼•èµ·" ï¼ˆæ•…æ„ä¼¤å®³ç½ªä»è½»ä¾æ®ï¼‰
- "å› å®¶åº­çŸ›ç›¾å¼•èµ·" ï¼ˆæ•…æ„ä¼¤å®³ç½ªä»è½»ä¾æ®ï¼‰
- "è¢«å®³äººè¿‡é”™" / "è¢«å®³äººæœ‰è¿‡é”™" ï¼ˆæ•…æ„ä¼¤å®³ç½ªä»è½»ï¼‰
- "æ­£å½“é˜²å«è¿‡å½“" / "ç´§æ€¥é¿é™©è¿‡å½“" ï¼ˆæ•…æ„ä¼¤å®³ç½ªç‰¹æ®Šæƒ…å½¢ï¼‰

---

## ä¸‰ã€ä¸€èˆ¬é‡åˆ‘æƒ…èŠ‚

### ä»è½»æƒ…èŠ‚
- "è‡ªé¦–" ï¼ˆä¸»åŠ¨æŠ•æ¡ˆ+å¦‚å®ä¾›è¿°ä¼¤å®³äº‹å®ï¼‰
- "å¦ç™½" ï¼ˆè¢«æŠ“åå¦‚å®ä¾›è¿°ä¼¤å®³çŠ¯ç½ªï¼‰
- "å½“åº­è‡ªæ„¿è®¤ç½ª" ï¼ˆåº­å®¡è®¤æ•…æ„ä¼¤å®³ç½ªï¼‰
- "ç«‹åŠŸ"
- "è¢«å®³äººè°…è§£" / "å–å¾—è¢«å®³äººè°…è§£" ï¼ˆä¼¤å®³è¢«å®³äººè°…è§£ï¼‰
- "ç§¯æèµ”å¿å¹¶å–å¾—è°…è§£" / "ç§¯æèµ”å¿ä½†æœªå–å¾—è°…è§£" / "æœªèµ”å¿ä½†å–å¾—è°…è§£"
- "ä»çŠ¯" ï¼ˆåœ¨æ•…æ„ä¼¤å®³å…±åŒçŠ¯ç½ªä¸­æ¬¡è¦ä½œç”¨ï¼‰
- "åˆçŠ¯" / "å¶çŠ¯"
- "æœªæˆå¹´äºº(16-18å²)" / "æœªæˆå¹´äºº(14-16å²)"

### ä»é‡æƒ…èŠ‚
- "ç´¯çŠ¯"
- "å‰ç§‘"
- "å‡é‡ŠæœŸé—´å†çŠ¯ç½ª" / "ç¼“åˆ‘è€ƒéªŒæœŸå†…å†çŠ¯ç½ª"
- "ä¸»çŠ¯" ï¼ˆåœ¨æ•…æ„ä¼¤å®³å…±åŒçŠ¯ç½ªä¸­ä¸»è¦ä½œç”¨ï¼‰
- **"æ‹’ä¸ä¾›è¿°"** / **"æ‹’ä¸è®¤ç½ª"** ï¼ˆâš ï¸ å¿…é¡»ç¬¦åˆCOMMON_SENTENCING_RULESä¸­çš„ä¸‰ä¸ªæ¡ä»¶ï¼‰

---

{common_rules}

---

## ã€æå–è§„åˆ™ã€‘
1. **ç¬¬ä¸€ä¸ªå…ƒç´ å›ºå®šä¸º"æ•…æ„ä¼¤å®³ç½ª"**
2. **ä¼¤å®³ç­‰çº§å¿…æ**ï¼šè½»ä¼¤/é‡ä¼¤å¿…é¡»æ˜ç¡®çº§åˆ«
3. **æ°‘é—´çº çº·ä¼˜å…ˆ**ï¼šå¦‚æœ‰æ­¤æƒ…èŠ‚ï¼Œæ˜¯é‡è¦ä»è½»ä¾æ®
4. **èµ”å¿+è°…è§£ç»„åˆ**ï¼šä¼˜å…ˆæå–ç»„åˆæƒ…èŠ‚
5. **âš ï¸ æ‹’ä¸ä¾›è¿°è¯†åˆ«**ï¼šå¿…é¡»æœ‰"ç¿»ä¾›""ç¼–é€ ç†ç”±"ç­‰æ˜ç¡®å¯¹æŠ—è¡Œä¸º

ã€æ¡ˆä»¶äº‹å®ã€‘
{fact}

ã€è¾“å‡ºè¦æ±‚ã€‘
ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºJSONæ•°ç»„ï¼Œä¸è¦è§£é‡Šï¼š
["æ•…æ„ä¼¤å®³ç½ª", "æƒ…èŠ‚1", "æƒ…èŠ‚2", ...]

**ç¬¬ä¸€ä¸ªå…ƒç´ å¿…é¡»æ˜¯"æ•…æ„ä¼¤å®³ç½ª"ï¼**
**âš ï¸ æå–"æ‹’ä¸ä¾›è¿°"å‰ï¼Œå¿…é¡»ç¡®è®¤ç¬¦åˆCOMMON_SENTENCING_RULESä¸­çš„ä¸‰ä¸ªæ¡ä»¶ï¼**
"""


# ==================== æ¨ç†å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰====================

def identify_crime_type(case_text: str) -> Optional[str]:
    """
    ä»æ¡ˆä»¶äº‹å®ä¸­è¯†åˆ«ç½ªå

    Args:
        case_text: æ¡ˆä»¶äº‹å®æè¿°

    Returns:
        è¯†åˆ«å‡ºçš„ç½ªå ("ç›—çªƒç½ª" / "è¯ˆéª—ç½ª" / "æ•…æ„ä¼¤å®³ç½ª")ï¼Œå¦‚æœæ— æ³•è¯†åˆ«è¿”å›None
    """
    # å…³é”®å­—åŒ¹é…è§„åˆ™ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰
    crime_keywords = {
        "ç›—çªƒç½ª": [
            "ç›—çªƒ", "çªƒå–", "å·çªƒ", "å·ç›—", "ç›—å–",
            "å…¥æˆ·ç›—çªƒ", "æ‰’çªƒ", "æºå¸¦å‡¶å™¨ç›—çªƒ", "å¤šæ¬¡ç›—çªƒ"
        ],
        "è¯ˆéª—ç½ª": [
            "è¯ˆéª—", "éª—å–", "å†’å……", "è™šæ„äº‹å®", "éšç’çœŸç›¸",
            "ç”µä¿¡è¯ˆéª—", "ç½‘ç»œè¯ˆéª—", "ç”µä¿¡ç½‘ç»œè¯ˆéª—"
        ],
        "æ•…æ„ä¼¤å®³ç½ª": [
            "æ•…æ„ä¼¤å®³", "ä¼¤å®³", "æ®´æ‰“", "æ‰“ä¼¤", "è‡´ä¼¤",
            "è½»ä¼¤", "é‡ä¼¤", "è‡´äººæ­»äº¡", "æŒæ¢°ä¼¤å®³"
        ]
    }

    # ç»Ÿè®¡æ¯ä¸ªç½ªåçš„å…³é”®å­—å‡ºç°æ¬¡æ•°
    crime_scores = {crime: 0 for crime in crime_keywords.keys()}

    for crime, keywords in crime_keywords.items():
        for keyword in keywords:
            if keyword in case_text:
                crime_scores[crime] += 1

    # æ‰¾å‡ºå¾—åˆ†æœ€é«˜çš„ç½ªå
    max_score = max(crime_scores.values())
    if max_score == 0:
        return None

    for crime, score in crime_scores.items():
        if score == max_score:
            return crime

    return None


def extract_sentencing_factors(case_text: str, crime_type: str) -> List[str]:
    """
    æå–é‡åˆ‘æƒ…èŠ‚ï¼ˆä¿æŒåŸå‡½æ•°ä¸å˜ï¼‰
    """
    client = OpenAI(
        api_key=DASHSCOPE_API_KEY,
        base_url=DASHSCOPE_BASE_URL
    )

    # æ ¹æ®ç½ªåé€‰æ‹©æç¤ºè¯
    if crime_type == "ç›—çªƒç½ª":
        system_prompt = TASK1_THEFT_SYSTEM
        user_template = TASK1_THEFT_USER
    elif crime_type == "è¯ˆéª—ç½ª":
        system_prompt = TASK1_FRAUD_SYSTEM
        user_template = TASK1_FRAUD_USER
    elif crime_type == "æ•…æ„ä¼¤å®³ç½ª":
        system_prompt = TASK1_ASSAULT_SYSTEM
        user_template = TASK1_ASSAULT_USER
    else:
        raise ValueError(f"æœªæ”¯æŒçš„ç½ªå: {crime_type}")

    # æ³¨å…¥é€šç”¨è§„åˆ™åˆ°ç”¨æˆ·æç¤ºè¯
    user_prompt = user_template.format(
        fact=case_text,
        common_rules=COMMON_SENTENCING_RULES
    )

    try:
        response = client.chat.completions.create(
            model=DASHSCOPE_MODEL_NAME,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=TEMPERATURE,
            max_tokens=MAX_TOKENS
        )

        result_text = response.choices[0].message.content.strip()

        # æå–JSONæ•°ç»„
        json_match = re.search(r'\[.*?\]', result_text, re.DOTALL)
        if json_match:
            factors = json.loads(json_match.group())
            # éªŒè¯ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å¦ä¸ºç½ªå
            if factors and factors[0] != crime_type:
                print(f"âš ï¸ è­¦å‘Šï¼šç¬¬ä¸€ä¸ªå…ƒç´ ä¸æ˜¯ç½ªå {crime_type}ï¼Œå·²è‡ªåŠ¨ä¿®æ­£")
                factors[0] = crime_type
            return factors
        else:
            print(f"âŒ æœªæ‰¾åˆ°æœ‰æ•ˆJSONï¼ŒåŸå§‹è¾“å‡ºï¼š{result_text}")
            return [crime_type]

    except Exception as e:
        print(f"âŒ APIè°ƒç”¨å¤±è´¥: {str(e)}")
        return [crime_type]


def process_task6():
    """å¤„ç†task6æ•°æ®é›†"""
    os.makedirs(os.path.dirname(OUTPUT_PATH), exist_ok=True)

    with open(DATA_PATH, 'r', encoding='utf-8') as f_in, \
            open(OUTPUT_PATH, 'w', encoding='utf-8') as f_out:

        for idx, line in enumerate(f_in, 1):
            data = json.loads(line.strip())
            case_id = data['id']
            case_text = data['fact']

            print(f"\n{'=' * 60}")
            print(f"æ­£åœ¨å¤„ç† [{idx}] ID: {case_id}")
            print(f"{'=' * 60}")

            # ğŸ”§ æ–°å¢ï¼šè¯†åˆ«ç½ªå
            crime_type = identify_crime_type(case_text)

            if crime_type is None:
                print(f"âŒ æ— æ³•è¯†åˆ«ç½ªåï¼Œè·³è¿‡è¯¥æ¡ˆä»¶")
                print(f"æ¡ˆä»¶äº‹å®ï¼š{case_text[:200]}...")
                continue

            print(f"âœ… è¯†åˆ«ç½ªå: {crime_type}")

            # æå–é‡åˆ‘æƒ…èŠ‚
            factors = extract_sentencing_factors(case_text, crime_type)

            # è¾“å‡ºç»“æœ
            result = {
                "id": case_id,
                "answer1": factors,
                "answer2": []  # âœ… æ–°å¢ï¼šæš‚æ—¶ç©ºç€å…ˆåšé‡åˆ‘æƒ…èŠ‚æå–
            }

            print(f"\nâœ… æå–ç»“æœ: {factors}")
            f_out.write(json.dumps(result, ensure_ascii=False) + '\n')
            f_out.flush()

    print(f"\n{'=' * 60}")
    print(f"âœ… å¤„ç†å®Œæˆï¼ç»“æœå·²ä¿å­˜è‡³: {OUTPUT_PATH}")
    print(f"{'=' * 60}")


if __name__ == "__main__":
    process_task6()

